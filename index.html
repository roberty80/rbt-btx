<!DOCTYPE html>
<html>
<head>
  <title>Camera Access</title>
  <style>
    #video {
      width: 640px;
      height: 480px;
      border: 1px solid black;
    }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://apis.google.com/js/platform.js"></script>
</head>
<body>
  <h1>Camera Test</h1>
  <video id="video" autoplay></video>
  <button id="start-button">Start Camera</button>
  <button id="stop-button">Stop Camera</button>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
  <button id="capture-button">Capture Image</button>
  <img id="captured-image" alt="Captured Image" style="display:none;">
  <button onclick="handleClientLoad()">Sign in with Google</button>

  <script>
    const video = document.getElementById('video');
    const startButton = document.getElementById('start-button');
    const stopButton = document.getElementById('stop-button');
    const captureButton = document.getElementById('capture-button');
    const canvas = document.getElementById('canvas');
    const capturedImage = document.getElementById('captured-image');
    let stream = null;

    startButton.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Error accessing camera. Please check permissions.');
      }
    });

    stopButton.addEventListener('click', () => {
      if (stream) {
        const tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        video.srcObject = null;
        stream = null;
      }
    });

    captureButton.addEventListener('click', () => {
      if (video.videoWidth > 0 && video.videoHeight > 0) {
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/png'); // or 'image/jpeg'

        // Convert imageData URL to Blob
        fetch(imageData)
          .then(res => res.blob())
          .then(blob => {
            uploadToDrive(blob); // Upload the captured photo as a Blob to Google Drive
          });
      }
    });

    function uploadToDrive(imageBlob) {
      const fileMetadata = {
        'name': 'captured_image.png',
        'mimeType': 'image/png'
      };

      const media = {
        mimeType: 'image/png',
        body: imageBlob
      };

      gapi.client.drive.files.create({
        resource: fileMetadata,
        media: media,
        fields: 'id'
      }).then((response) => {
        console.log('File uploaded successfully', response);
      }).catch((error) => {
        console.error('Error uploading file', error);
      });
    }

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      gapi.client.init({
        apiKey: 'YOUR_API_KEY',
        clientId: 'YOUR_CLIENT_ID',
        scope: 'https://www.googleapis.com/auth/drive.file',
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      }).then(() => {
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      });
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        console.log('User is signed in!');
      } else {
        gapi.auth2.getAuthInstance().signIn();
      }
    }
  </script>
</body>
</html>
